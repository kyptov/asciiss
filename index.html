<!DOCTYPE html>
<script src="node_modules/asciirocks/scripts/ansi.js" type="text/javascript"></script>
<script src="node_modules/asciirocks/scripts/jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="node_modules/asciirocks/scripts/jquery-ui-1.10.4.custom.min.js"></script>
<script src="node_modules/asciirocks/scripts/app.js"></script>
<script src="node_modules/asciirocks/scripts/interpreter.js"></script>
<script src="scripts/x256.js"></script>
<script src="scripts/parse.js"></script>
<link rel="stylesheet" href="node_modules/asciirocks/css/panel.css" type="text/css" media="screen" />
<link rel="stylesheet" href="node_modules/asciirocks/css/style.css" type="text/css" media="screen" />
<style>
    #ascii_content {
        font-family:Courier, Mono, Monaco;
        font-size:10px;
        letter-spacing:0px;
    }

    #ascii_content div {
        display:inline-block;
    }
</style>
<script>
    var doubleClickStarted = false;
    var doubleClickInterval;
   
   /** This registers a key event listener, so entering something in the browser has functionality **/
   function registerParsedKeyEventListener() {
		
                document.body.addEventListener('keypress',
                function(e)
                {
                
                    var keyCode = e.which;
                   
                    if (keyCode!=0) {
                        e.preventDefault(); 
                        
                        handleParsedKeyCode(keyCode,e);
                    }
                
                },
                false);
                
                document.body.addEventListener('keydown',
                function(e)
                {
                 
                    var keyCode = e.which;
                  
					if (keyCode == 17) {
                        ctrlKey=true;
                    } else
                    if (keyCode==27) {
                         if ($('#panel').css('display')=="block") {
                            hidePanel(); } else {
                            showPanel();
                            }
                    } else
                    if ( (keyCode<=40) && (keyCode>=37) ) { 
                        e.preventDefault();
                        handleParsedKeyCode2(keyCode,e);
                    } /*else if (keyCode==8) {
                        e.preventDefault();
                        handleParsedKeyCode(keyCode, e);
                    }*/
                    
                
                },
                false);
                
               
                
    }
   
   
   

    window.onload = function() {
        
        registerParsedKeyEventListener();
        
		// At the start, if there already is some HTML, the user gets asked if he wants to keep the original HTML
        if (localStorage.getItem("html")!=null) {
            if (confirm('Do you want to keep the HTML you have entered before?')) {
                $('#ascii_textarea').val(localStorage.getItem("html"));
            } else {
                localStorage.clear();
            }
        }
        
		// This defines the screen width in characters
        width = 160;
		// Here the height
        height = 60;
		// Different modes of showing the characters: Either resized so it fits on the screen, or taking the width of characters for the height
        resizeToScreen = true;

		// Initializes the canvas object using the image that is available inside the images directory for. The image consists of 8x16px blocks in different colors.
        codepage = new Codepage("node_modules/asciirocks/images/CO_437_8x16.png", function() {

            setCanvasSize(document.getElementById("ansi"));
            setANSICanvasSize();

            globalContext = document.getElementById("ansi").getContext("2d");

            charactersatonce = 999999; //Math.floor((baud || 115200) / 8 / 100);
            doClearScreen(false);
            switchbutton(); // Shows the canvas right from the start and hides the HTML
        });
        
		// This gets called whenever the user clicks on the Canvas
          document.getElementById('ansi').addEventListener('mousedown', function(e) {
                   
                    if (doubleClickStarted)
                    {
                        doubleClickStarted=false;
                        switchbutton();
                        clearTimeout(doubleClickInterval);
                    }
                    doubleClickStarted = true;
                    doubleClickInterval = setTimeout(function() { doubleClickStarted=false; }, 300);
                   
                    var ansicanvas = document.getElementById('ansi');
                    var mouse = getMousePos(ansicanvas, e);
                    var mx = mouse.x;
                    var my = mouse.y;                    
                    
                    showCharacter();
                    
                    myCursorPosX = Math.floor(mx / canvasCharacterWidth);
                    myCursorPosY = Math.floor(my / canvasCharacterHeight);
                    
                    if (myCursorPosX>=getDisplayWidth()-1) { console.log(myCursorPosX+" too far"); setCursorPosX(getDisplayWidth()-1); redrawCursor(); return; }
                    if (myCursorPosY>=getDisplayHeight()-1) { console.log(myCursorPosY+" too high"); setCursorPosY(getDisplayHeight()-1); redrawCursor(); return; }
                    
                    
                    checkSelectionOnParsed(myCursorPosX, myCursorPosY);
                    
                    
                    
                });
        
        
    };

    

	// Gets called from calculateContent and shows the parameter text at the given x and y position on the canvas
    function printthat(text, positionx, positiony,rgb_color,rgb_backgroundcolor) {

        //alert(rgb_color[0]+"/"+rgb_color[1]+"/"+rgb_color[2]);

		// Then iterate over the given text.
        for (var i = 0; i < text.length; i++) {
            var asciiCode = text.charCodeAt(i);
            if (asciiCode >= 32)
            {
               
                var fgColor = x256(rgb_color[0], rgb_color[1], rgb_color[2]);
                var bgColor = x256(rgb_backgroundcolor[0], rgb_backgroundcolor[1], rgb_backgroundcolor[2]);
				// Draw on canvas
                                
                codepage.drawChar(ctx, asciiCode, fgColor, bgColor, positionx + i, positiony);
            }
        }


    }

	// This is just a test function if the ascii table works and gets properly shown
    function testAsciiTable() {

        $('#switchbutton').val('Show HTML');
        $('#ansi').show();
        $('#ascii_html').hide();
        drawAsciiTable();
    }




	// gets called from testAsciiTable and the only purpose is testing the ascii table.
    function drawAsciiTable() {
        for (var i = 0; i < 255; i++)
        {
            y = 0;
            var x = i;
            while (x > 80)
            {
                y++;
                x = x - 81;
            }

            console.log("x:" + x + "y:" + y);

            codepage.drawChar(ctx, i, 0, 1, x, y);
        }
    }
    
    
</script>
<body style="width:100%;height:100%;">
    <title>Ascii Stylesheet</title>
    <div id="ascii_content" style="opacity:0" ></div> <!-- must be at the top position for coordinate getters to work -->
    <span id="ascii_html">
	<!-- This is the textarea which is used for entering the HTML and CSS for showing the page on the canvas -->
        The HTML:<textarea id="ascii_textarea" style="width:1024px;height:640;" rows="20" onkeyup="updateAsciiArea();">
<span style="top:20px;left:20px;color:white;">This look and feel of this text was made by defining CSS style attributes. The HTML was parsed by javascript and the result is this.</span>
<span style="top:22px;left:20px;color:#3caac8;">Please login!</span>
<form onsubmit="submit();">
    <span style="top:25px;left:20px;color:white;">Username: <input type="text" name="username" value="Guest"/></span>
    <span style="top:27px;left:20px;color:white;">Password: <input type="text" name="password" /><span style="left:45px;"><input type="button" onclick="submit();"></span></span>
</form>

        </textarea>
    </span>

    <canvas id="ansi" width="640" height="480" style="display:none"></canvas>
	<!-- Two buttons to change between the views -->
    <input type="button" value="Show Ascii" id="switchbutton" onclick="switchbutton();"/>
    <input type="button" value="Test ascii table" id="testasciitable" onclick="testAsciiTable();" />